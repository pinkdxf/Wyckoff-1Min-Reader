name: Data Feeder (360 Bars CSV)

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # GitHub Actions ä½¿ç”¨ UTC æ—¶é—´ (åŒ—äº¬æ—¶é—´ -8å°æ—¶)
    # åŒ—äº¬ 10:00, 11:00, 12:00, 14:00 -> UTC 02, 03, 04, 06
    - cron: "0 2,3,4,6 * * *"
    # åŒ—äº¬ 13:30, 14:30 -> UTC 05:30, 06:30
    - cron: "30 5,6 * * *"

jobs:
  fetch-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # åœ¨è¿™é‡Œå®šä¹‰ä½ è¦æŠ“å–çš„æ‰€æœ‰è‚¡ç¥¨ä»£ç 
        symbol: ["600970", "002641"]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Script for ${{ matrix.symbol }}
        env:
          # ä½¿ç”¨çŸ©é˜µä¸­çš„è‚¡ç¥¨ä»£ç 
          SYMBOL: ${{ matrix.symbol }}
          # è®¾å®šä¸ºä½ è¦æ±‚çš„ 360 æ ¹
          BARS_COUNT: "360"
          # å¦‚æœä¸æƒ³æ¶ˆè€— AI é¢åº¦ï¼Œå¯ä»¥éšä¾¿å¡«ä¸ªå‡çš„ Key æˆ–è€…ç•™ç©º(å‰ææ˜¯ä»£ç æœ‰å®¹é”™)
          # ä½†ä¸ºäº†ä¿è¯ç¨‹åºä¸æŠ¥é”™ï¼Œå»ºè®®è¿˜æ˜¯å¡«ä¸Š Secrets
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          mkdir -p reports
          mkdir -p data
          # è¿è¡Œä¸»ç¨‹åº
          python main.py

      - name: Push CSV to Telegram
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          SYMBOL: ${{ matrix.symbol }}
        run: |
          # æŸ¥æ‰¾è¯¥è‚¡ç¥¨æœ€æ–°ç”Ÿæˆçš„ CSV æ–‡ä»¶
          CSV_FILE=$(ls -1t data/${SYMBOL}_1min_*.csv 2>/dev/null | head -n 1)

          if [ -z "$CSV_FILE" ]; then
            echo "Error: No CSV file found for $SYMBOL"
            exit 1
          fi

          echo "Found CSV: $CSV_FILE"
          
          # å‘é€æ–‡æ¡£åˆ° Telegram
          # ä½¿ç”¨ -F document=@æ–‡ä»¶è·¯å¾„ æ¥å‘é€æ–‡ä»¶
          curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
            -F chat_id="${TG_CHAT_ID}" \
            -F document="@$CSV_FILE" \
            -F caption="ğŸ“Š #${SYMBOL} 1åˆ†é’Ÿæ•°æ® (æœ€è¿‘360æ ¹)
          ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')"
